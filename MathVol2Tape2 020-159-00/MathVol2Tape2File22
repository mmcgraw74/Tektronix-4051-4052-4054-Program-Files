1 REM  SOLUTION OF STIFF SYSTEMS OF ODE'S BY PREDICTOR-CORRECTOR
2 GO TO 5
3 DELETE 2,22
5 DELETE 2
7 PRINT "ENTER YOUR EQUATIONS AS A SUBROUTINE STARTING AT LINE #1100."
9 PRINT "A SAMPLE SET OF EQUATIONS IS PROVIDED:J_J_"
11 LIST 1100,1190
13 PRINT "J_J_J_YOU WILL ALSO NEED TO CHANGE THE LINES:J_J_"
15 LIST 140,150
17 PRINT 
19 LIST 180,190
21 PRINT "J_J_"
22 END 
100 REM
110 REM  ************************************************************
120 REM  SAMPLE USER WRITTEN DRIVER FOR PREDICTOR-CORRECTOR ODE
130 PAGE 
140 N=2
150 A=1
160 DELETE Y,Y0,E0,D
170 DIM Y(8,N),Y0(N),E0(N),D(N)
180 Y(1,1)=0.4400505857
190 Y(1,2)=0.325147100829
200 PRINT "ENTER B = ";
210 INPUT B
220 PRINT "J_ENTER H,H0,H1 = ";
230 INPUT H,H0,H1
240 PRINT "J_ENTER F,F2 = ";
250 INPUT F,F2
260 PRINT "J_ENTER N0,E = ";
270 INPUT N0,E
280 PRINT 
290 PRINT 
300 GOSUB 2500
310 END 
320 REM  END OF SAMPLE USER WRITTEN DRIVER 
330 REM ************************************************************
1100 REM
1110 REM ***********************************************************
1120 REM EVALUATE THE DERIVATIVES OF Y.  THIS ROUTINE MUST BE 
1130 REM WRITTEN BY THE USER. FOR EXAMPLE:
1140 D(1)=Y(1,2)
1150 D(2)=-(X*Y(1,2)+(X*X-1)*Y(1,1))/(X*X)
1160 RETURN 
1170 REM  END OF ROUTINE TO EVALUATE THE DERIVATIVES OF Y
1180 REM 
1190 REM  ********************************************************
1200 REM  COMPUTE PARTIAL DERIVATIVES WITH RESPECT TO YI.  THIS 
1210 REM       ROUTINE (AN OPTIOANL USER WRITTEN ROUTINE) IS
1220 REM       CALLED ONLY IF  F=1 .  FOR EXAMPLE:
1230 Q9(1,1)=0
1240 Q9(1,2)=1
1250 Q9(2,1)=1/(X*X)-1
1260 Q9(2,2)=-1/X
1270 RETURN 
1280 REM  END OF ROUTINE TO EVALUATE PARTIAL DERIVATIVES. 
1290 REM
1300 REM  *********************************************************
1500 REM  DIFSUB - SOLVES N SIMULTANEOUS 1ST ORDER ORDINARY
1510 REM           DIFFERENTIAL EQUATIONS. 
1520 REM 
1530 REM  REFN:  GEAR,C.W. "DIFSUB FOR SOLUTION OF 
1540 REM       ORDINARY DIFFERENTIAL EQUATIONS (D2)" 
1550 REM       CACM ALGORITHM 407. 
1560 REM  REFN:  FORSYTHE, GEORGE E. AND CLEVE B. MOLER, 
1570 REM       "COMPUTER SOLUTION OF LINEAR ALGEBRAIC SYSTEMS" 
1580 REM       ENGLEWOOD CLIFFS, N.J., PRENTICE-HALL, 1967.
1590 REM 
1600 REM  PARAMETERS 
1610 REM    N - THE NUMBER OF DIFFERENTIAL EQUATIONS (INPUT)
1620 REM    N0- THE MAX. DERIVATIVE THAT SHOULD BE USED BY DIFSUB. 
1630 REM        THE ORDER OF THE METHOD IS EQUAL TO N0.  IT MUST 
1640 REM        BE LESS THAN 8 FOR ADAMS METHOD AND 7 FOR STIFF
1650 REM        METHOD. (INPUT)
1660 REM    A - STARTING POINT FOR "INTEGRATION" (INPUT)
1670 REM    B - ENDING POINT FOR "INTEGRATION" (INPUT)
1680 REM    H - (INPUT) STEP SIZE FOR OUTPUT.  Y VALUES ARE OUTPUT
1690 REM        AT A,B AND INTERMEDIATE POINTS.  SEE F2 BELOW
1700 REM        H*(B-A) MUST BE > 0.  ALSO, SIG(H)=SIG(H0)=SIG(H1) 
1710 REM        ACTUAL STEP SIZE IS ADJUSTED AUTOMATICALLY 
1720 REM    H0- MIN. STEP SIZE TO BE USED.  THIS MUST BE MUCH
1730 REM        SMALLER THAN THE AVERAGE STEP EXPECTED SINCE 
1740 REM        A FIRST ORDER METHOD IS USED INITIALLY. (INPUT)
1750 REM    H1- MAX. STEP SIZE TO BE USED. (INPUT)
1760 REM    E - RELATIVE ERROR TEST CONSTANT.  SINGLE STEP ERROR 
1770 REM        ESTIMATES DIVIDED BY Y0(I) MUST BE LESS THAN THIS
1780 REM        IN THE EUCLIDEAN NORM.  THE STEP SIZE AND/OR 
1790 REM        ORDER IS ADJUSTED TO ACHIEVE THIS. (INPUT)
1800 REM    F - (INPUT) THE METHOD FLAG.  THE FOLLOWING ARE ALLOWED:
1810 REM         0  AN ADAMS PREDICTOR CORRECTOR IS USED 
1820 REM         1  A MULTI-STEP METHOD SUITABLE FOR STIFF SYSTEMS 
1830 REM              IS USED.  IT WILL ALSO WORK FOR NON-STIFF
1840 REM              SYSTEMS.  THE USER MUST PROVIDE A SUBROUTINE 
1850 REM              TO EVALUATE PARTIAL DERIVATIVES (SEE GOSUB 
1860 REM              1200 , BELOW)
1870 REM         2  THE SAME AS CASE 1, EXCEPT THAT THE PARTIAL
1880 REM            DERIVATIVES ARE APPROXIMATED NUMERICALLY, SO THE 
1890 REM            USER DOES NOT HAVE TO PROVIDE A SUBROUTINE.
1900 REM    F2- AN INPUT PARAMETER WITH THE FOLLOWING MEANING: 
1910 REM         0  PRINT YI ONLY AT A,A+H,A+2H,...., AND B
1920 REM         1  PRINT YI WHEREVER IT IS CALCULATED.
1930 REM    Y - AN 8 BY N ARRAY CONTAINING THE DEPENDENT VARIABLES 
1940 REM         AND THEIR SCALED DERIVATIVES.  Y(J+1,I) CONTAINS
1950 REM         THE J-TH DERIVATIVE OF YI SCALED BY P9^J/J, 
1960 REM         WHERE P9 IS THE CURRENT STEP SIZE.  ONLY Y(1,I) NEED
1970 REM         BE PROVIDED BY THE USER. (INPUT)
1980 REM             IF IT IS DESIRED TO INTERPOLATE TO NON MESH 
1990 REM         POINTS THE VALUES IN Y CAN BE USED.  IF THE Y 
2000 REM         ARRAY IS KNOWN AT THE MESH POINT X, THEN: 
2010 REM                           F1
2020 REM               YI(X+Z) =  SUM  Y(J+1,I)*(Z/P9)^J 
2030 REM                          J=0
2040 REM    Y0- AN ARRAY OF N LOCATIONS WHICH CONTAIN THE MAXIMUM OF 
2050 REM        EACH Y SEEN SO FAR.  IT IS INITIALIZED TO 1. (OUTPUT)
2060 REM    E0- AN ARRAY OF N LOCATIONS WHICH CONTAIN THE ESTIMATED
2070 REM        ONE STEP ERROR IN EACH COMPONENT. (OUTPUT)
2080 REM    D - AN ARRAY OF N LOCATIONS WHICH CONTAIN THE DERIVATIVES
2090 REM        OF THE DEPENDENT VARIABLES YI (SEE GOSUB 1100 BELOW) 
2100 REM    GOSUB 1100 - A USER WRITTEN ROUTINE WHICH MUST ALWAYS BE 
2110 REM        PROVIDED.  IT MUST EVALUATE THE DERIVATIVES OF YI WITH
2120 REM        RESPECT TO X AND PLACE THE RESULT IN D(I) .
2130 REM    GOSUB 1200 - AN OPTIONAL USER WRITTEN SUBROUTINE CALLED
2140 REM        ONLY IF  F=1 .   IT SHOULD COMPUTE THE PARTIAL DERIV-
2150 REM        ATIVES OF THE DIFFERENTIAL EQUATION WITH RESPECT TO THE
2160 REM        DEPENDENT VARIABLES YI.  THE PARTIAL OF THE J'TH 
2170 REM        EQUATION WITH RESPECT TO YI AT POINT X SHOULD BE 
2180 REM        STORED IN Q9(J,I). 
2190 REM  *****************************************************
2200 REM  DRIVER AND OUTPUT FOR GEAR'S DIFSUB ROUTINE. 
2500 DELETE P,Q9,P0,Q0,Q,Q5,Q6
2510 DIM P(12*N),Q9(N,N),P0(8),Q0(7,6),Q(32),Q5(N),Q6(N)
2520 FUZZ 10,1.0E-10
2530 Q8=INT(F/2+0.6)
2540 IF Q8+N0<9 THEN 2590
2550 PRINT "J_ERROR:  ORDER (N0) IS TOO LARGE"
2560 END 
2570 REM 
2580 REM  INITIALIZE COEFFICIENTS  ********************* 
2590 Q0(1,1)=2
2600 Q0(2,1)=4.5
2610 Q0(3,1)=7.33333
2620 Q0(4,1)=10.42
2630 Q0(5,1)=13.7
2640 Q0(6,1)=17.15
2650 Q0(7,1)=1
2660 Q0(1,2)=2
2670 Q0(2,2)=12
2680 Q0(3,2)=24
2690 Q0(4,2)=37.89
2700 Q0(5,2)=53.333
2710 Q0(6,2)=70.08
2720 Q0(7,2)=87.97
2730 Q0(1,3)=3
2740 Q0(2,3)=6
2750 Q0(3,3)=9.167
2760 Q0(4,3)=12.5
2770 Q0(5,3)=15.98
2780 Q0(6,3)=1
2790 Q0(7,3)=1
2800 Q0(1,4)=12
2810 Q0(2,4)=24
2820 Q0(3,4)=37.89
2830 Q0(4,4)=53.333
2840 Q0(5,4)=70.08
2850 Q0(6,4)=87.97
2860 Q0(7,4)=1
2870 Q0(1,5)=1
2880 Q0(2,5)=1
2890 Q0(3,5)=0.5
2900 Q0(4,5)=0.16667
2910 Q0(5,5)=0.041333
2920 Q0(6,5)=0.008267
2930 Q0(7,5)=1
2940 Q0(1,6)=1
2950 Q0(2,6)=1
2960 Q0(3,6)=2
2970 Q0(4,6)=1
2980 Q0(5,6)=0.3157
2990 Q0(6,6)=0.07407
3000 Q0(7,6)=0.0139
3010 P0(2)=-1
3020 PRINT "THE OUTPUT ROWS ARE X,Y1,...,YNJ_"
3030 X=SGN(B-A)
3040 H=X*ABS(H)
3050 H0=X*ABS(H0)
3060 H1=X*ABS(H1)
3070 X=A
3080 F0=1
3090 F1=0
3100 Q(31)=A
3110 REM  INITIALIZE Y AND Y0 ********************* 
3120 FOR P1=1 TO N
3130 Y0(P1)=1
3140 E0(P1)=0
3150 FOR P2=2 TO 8
3160 Y(P2,P1)=0
3170 NEXT P2
3180 NEXT P1
3190 P9=SGN(H)*SQR(H0*H1)
3200 Q(32)=0.5*(H0+H1)
3210 REM   *****************************************
3220 REM  *******OUTPUT ROUTINE*****
3230 IF F2<>0 OR F0<0 THEN 3260
3240 IF SGN(H1)*(X-Q(31))<0 THEN 3370
3250 GO TO 3270
3260 IF SGN(H1)*(X-Q(31))<0 THEN 3310
3270 Q(31)=Q(31)+H
3280 IF H*(Q(31)-B)<=0 THEN 3310
3290 H=B-Q(31)+H
3300 Q(31)=B
3310 PRINT X,"";
3320 FOR P1=1 TO N
3330 PRINT Y(1,P1),"";
3340 NEXT P1
3350 PRINT 
3360 IF SGN(H1)*(X-B)=>0 THEN 3400
3370 IF F0>0 THEN 3410
3380 PRINT "J_ERROR:  LAST INTEGRATION STEP WAS NOT SUCCESSFUL"
3390 PRINT "J_X = ";X;"  AND F0 = ";F0
3400 END 
3410 IF P9/Q(32)=>1 THEN 3430
3420 P9=Q(32)
3430 GOSUB 4500
3440 GO TO 3230
3450 REM  ******* END OF DRIVER FOR GEAR'S DIFSUB ROUTINE *********
3460 REM  *********************************************************
3470 REM
3480 REM 
3800 REM  GEAR'S DIFSUB ROUTINE (CACM ALG. 407)
3810 REM     THIS ROUTINE INTEGRATES A SET OF N ORDINARY DIFFERENTIAL
3820 REM     EQUATIONS ONE STEP OF LENGHT P9, TO ERROR < E.
3830 REM  PARAMETERS 
3840 REM    F0- (OUTPUT) A COMPLETION CODE WITH THE FOLLOWING MEANING:
3850 REM         +1  THE STEP WAS SUCCESFUL
3860 REM         -1  THE STEP WAS TAKEN WITH SIZE = H0 BUT THE 
3870 REM             REQUESTED ERROR WAS NOT ACHIEVED. 
3880 REM         -2  N0 WAS TOO LARGE
3890 REM         -3  CORRECTOR CONVERGENCE COULD NOT BE ACHIEVED FOR 
3900 REM             STEP SIZE > H0
3910 REM         -4  E IS TOO SMALL FOR THIS PROBLEM 
3920 REM    F1- AN INPUT INDICATOR WITH THE FOLLOWING MEANING: 
3930 REM         -1  REPEAT THE LAST STEP WITH A NEW STEP SIZE 
3940 REM          0  PERFORM THE FIRST STEP.  CAUSES THE ROUTINE TO
3950 REM             INITIALIZE ITSELF.
3960 REM          AT EXIT, F1 IS SET TO THE CURRENT ORDER OF THE METHOD
3970 REM    P9- THE STEP SIZE TO BE ATTEMPTED ON THIS CALL TO GEAR'S
3980 REM        DIFSUB.  SIZE CONTROLED AUTOMATICALLY TO ACHIEVE
3990 REM        ERROR < E.  (INPUT)
4000 REM    Q(31) - (INPUT) THE ENDING POINT FOR THIS STEP.
4010 REM
4500 IF P9*(X+P9-Q(31))<=0 THEN 4520
4510 P9=Q(31)-X
4520 Q(11)=1
4530 F0=1
4540 IF F1<=0 THEN 4760
4550 REM 
4560 REM  BEGIN BY SAVING INFORMATION FOR POSSIBLE RESTARTS. ********
4570 Q8=0
4580 FOR P1=1 TO N
4590 FOR P2=1 TO P3
4600 P(P2+Q8)=Y(P2,P1)
4610 NEXT P2
4620 Q8=Q8+10
4630 NEXT P1
4640 Q(8)=Q(9)
4650 IF P9=Q(8) THEN 4700
4660 Q(21)=P9/Q(8)
4670 Q(12)=1
4680 GO TO 8430
4690 REM        ****************** 
4700 Q(17)=Q(16)
4710 Q(22)=X
4720 Q(21)=1
4730 IF F1>0 THEN 5930
4740 GO TO 5040
4750 REM        ****************** 
4760 IF F1=-1 THEN 4960
4770 REM 
4780 REM  ON THE FIRST CALL THE ORDER (Q(16)) IS SET TO 1 AND THE
4790 REM     INITIAL DERIVATIVES ARE CALCULATED. 
4800 Q(16)=1
4810 P7=10*N
4820 P8=P7+1
4830 Q1=N^2
4840 Q2=P7+N
4850 Q3=Q2+1
4860 GOSUB 1100
4870 FOR P1=1 TO N
4880 P(P7+P1)=D(P1)
4890 Y(2,P1)=D(P1)*P9
4900 NEXT P1
4910 Q(9)=P9
4920 P3=2
4930 GO TO 4570
4940 REM 
4950 REM  REPEAT LAST STEP BY RESTORING SAVED INFORMATION. 
4960 IF Q(16)<>Q(17) THEN 4980
4970 F1=1
4980 X=Q(22)
4990 Q(16)=Q(17)
5000 P3=Q(16)+1
5010 GO TO 4660
5020 REM 
5030 REM  SET THE COEFFICIENTS DETERMINED BY THE ORDER AND METHOD. 
5040 IF F=0 THEN 5070
5050 IF Q(16)>6 THEN 5090
5060 GO TO Q(16) OF 5490,5510,5540,5580,5630,5690
5070 IF Q(16)>7 THEN 5090
5080 GO TO Q(16) OF 5140,5160,5190,5230,5280,5340,5410
5090 F0=-2
5100 RETURN 
5110 REM 
5120 REM  THE FOLLOWING COEFFICIENTS SHOULD BE DEFINED TO THE  
5130 REM     MAXIMUM ACCURACY PERMITTED BY THE MACHINE.
5140 P0(1)=-1
5150 GO TO 5760
5160 P0(1)=-0.5
5170 P0(3)=-0.5
5180 GO TO 5760
5190 P0(1)=-5/12
5200 P0(3)=-0.75
5210 P0(4)=-1/6
5220 GO TO 5760
5230 P0(1)=-0.375
5240 P0(3)=-11/12
5250 P0(4)=-1/3
5260 P0(5)=-1/24
5270 GO TO 5760
5280 P0(1)=-251/720
5290 P0(3)=-25/24
5300 P0(4)=-35/72
5310 P0(5)=-5/48
5320 P0(6)=-1/120
5330 GO TO 5760
5340 P0(1)=-95/288
5350 P0(3)=-137/120
5360 P0(4)=-0.625
5370 P0(5)=-17/96
5380 P0(6)=-0.025
5390 P0(7)=-1/720
5400 GO TO 5760
5410 P0(1)=-19087/60480
5420 P0(3)=-1.235
5430 P0(4)=-203/270
5440 P0(5)=-49/192
5450 P0(6)=-7/144
5460 P0(7)=-7/1440
5470 P0(8)=-1/5040
5480 GO TO 5760
5490 P0(1)=-1
5500 GO TO 5760
5510 P0(1)=-2/3
5520 P0(3)=-1/3
5530 GO TO 5760
5540 P0(1)=-6/11
5550 P0(3)=-6/11
5560 P0(4)=-1/11
5570 GO TO 5760
5580 P0(1)=-0.48
5590 P0(3)=-0.7
5600 P0(4)=-0.2
5610 P0(5)=-0.02
5620 GO TO 5760
5630 P0(1)=-120/274
5640 P0(3)=-225/274
5650 P0(4)=-85/274
5660 P0(5)=-15/274
5670 P0(6)=-1/274
5680 GO TO 5760
5690 P0(1)=-180/441
5700 P0(3)=-58/63
5710 P0(4)=-15/36
5720 P0(5)=-25/252
5730 P0(6)=-3/252
5740 P0(7)=-1/1764
5750 REM          ****************** 
5760 P3=Q(16)+1
5770 Q(10)=P3
5780 Q(14)=INT((4-F)/2)
5790 Q8=Q(16)
5800 Q(4)=0.5/Q8
5810 Q(5)=0.5/P3
5820 Q(6)=0.5/(P3+1)
5830 Q(19)=E
5840 Q(7)=(Q0(Q8,(Q(14)+2))*E)^2
5850 Q(3)=(Q0(Q8,(Q(14)+4))*E)^2
5860 Q(2)=(Q0(Q8,Q(14))*E)^2
5870 IF Q(3)=0 THEN 8640
5880 Q(1)=E*Q(6)/N
5890 Q(13)=F
5900 GO TO Q(11) OF 5930,8030
5910 REM 
5920 REM  COMPUTE PREDICTED VALUES FROM SAVED INFORMATION. **********
5930 X=X+P9
5940 FOR P2=2 TO P3
5950 FOR P4=P2 TO P3
5960 P5=P3-P4+P2-1
5970 FOR P1=1 TO N
5980 Y(P5,P1)=Y(P5,P1)+Y(P5+1,P1)
5990 NEXT P1
6000 NEXT P4
6010 NEXT P2
6020 REM 
6030 REM  UP TO 3 CORRECTOR ITERATIONS ARE TAKEN. *****************
6040 FOR P1=1 TO N
6050 E0(P1)=0
6060 NEXT P1
6070 FOR P6=1 TO 3
6080 GOSUB 1100
6090 FOR P1=1 TO N
6100 P(P7+P1)=D(P1)
6110 NEXT P1
6120 REM 
6130 REM  FOR STIFF METHODS, Q9 IS RE-EVALUATED IF THERE HAS BEEN A
6140 REM     CHANGE OF ORDER OR TROUBLE WITH CONVERGENCE.
6150 IF Q(13)<1 THEN 6540
6160 IF F=2 THEN 6310
6170 GOSUB 1190
6180 REM    ****************** 
6190 Q8=P0(1)*P9
6200 Q(20)=Q8
6210 Q9=Q8*Q9
6220 FOR P1=1 TO N
6230 Q9(P1,P1)=1+Q9(P1,P1)
6240 NEXT P1
6250 Q(13)=-1
6260 GOSUB 8730
6270 REM  (PERFORMS AN LU DECOMPOSITION OF Q9) 
6280 IF P4>0 THEN 6540
6290 GO TO 6830
6300 REM      **************** 
6310 Q8=9
6320 FOR P1=1 TO N
6330 P(Q8)=Y(1,P1)
6340 Q8=Q8+10
6350 NEXT P1
6360 Q4=9
6370 FOR P2=1 TO N
6380 Q8=E^2
6390 IF E>ABS(P(Q4)) THEN 6410
6400 Q8=E*ABS(P(Q4))
6410 Y(1,P2)=Y(1,P2)+Q8
6420 Q7=P0(1)*P9/Q8
6430 GOSUB 1100
6440 FOR P1=1 TO N
6450 P(Q2+P1)=D(P1)
6460 Q9(P1,P2)=(D(P1)-P(P7+P1))*Q7
6470 NEXT P1
6480 Y(1,P2)=P(Q4)
6490 Q4=Q4+10
6500 NEXT P2
6510 Q(20)=Q8
6520 GO TO 6220
6530 REM    ******************** 
6540 IF F<>0 THEN 6620
6550 Q8=9
6560 FOR P1=1 TO N
6570 P(Q8)=Y(2,P1)-P((P7+P1))*P9
6580 Q8=Q8+10
6590 NEXT P1
6600 GO TO 6670
6610 REM      *****************
6620 FOR P1=1 TO N
6630 P(Q2+P1)=Y(2,P1)-P((P7+P1))*P9
6640 NEXT P1
6650 GOSUB 9250
6660 REM  (SOLVES Q9*X=B, WHERE Q9 IS IN LU FORM)
6670 Q7=N
6680 Q4=Q(1)
6690 Q8=9
6700 FOR P1=1 TO N
6710 Y(1,P1)=Y(1,P1)+P0(1)*P(Q8)
6720 Y(2,P1)=Y(2,P1)-P(Q8)
6730 E0(P1)=E0(P1)+P(Q8)
6740 IF ABS(P(Q8))>Q4*Y0(P1) THEN 6760
6750 Q7=Q7-1
6760 Q8=Q8+10
6770 NEXT P1
6780 Q(18)=Q7
6790 IF Q7<=0 THEN 7070
6800 NEXT P6
6810 REM 
6820 REM  CORRECTOR ITERATION FAILED TO CONVERGE IN 3 TRIES
6830 X=X-P9
6840 IF P9>H0*1.00001 THEN 6860
6850 IF Q(13)-Q(14)<-1 THEN 6930
6860 IF F=0 THEN 6880
6870 IF Q(13)=0 THEN 6890
6880 Q(21)=0.25*Q(21)
6890 Q(13)=F
6900 Q(12)=2
6910 GO TO 8430
6920 REM      *******************
6930 F0=-3
6940 Q8=0
6950 FOR P1=1 TO N
6960 FOR P2=1 TO P3
6970 Y(P2,P1)=P(P2+Q8)
6980 NEXT P2
6990 Q8=Q8+10
7000 NEXT P1
7010 P9=Q(8)
7020 F1=Q(17)
7030 Q(16)=F1
7040 RETURN 
7050 REM 
7060 REM  CORRECTOR CONVERGED  *************** 
7070 Q7=0
7080 FOR P1=1 TO N
7090 Q7=Q7+(E0(P1)/Y0(P1))^2
7100 NEXT P1
7110 Q(13)=0
7120 IF Q7>Q(2) THEN 7320
7130 IF P3<3 THEN 7200
7140 FOR P2=3 TO P3
7150 Q8=P0(P2)
7160 FOR P1=1 TO N
7170 Y(P2,P1)=Y(P2,P1)+Q8*E0(P1)
7180 NEXT P1
7190 NEXT P2
7200 F0=1
7210 Q(9)=P9
7220 IF Q(10)<=1 THEN 7360
7230 Q(10)=Q(10)-1
7240 IF Q(10)>1 THEN 8120
7250 Q8=10
7260 FOR P1=1 TO N
7270 P(Q8)=E0(P1)
7280 Q8=Q8+10
7290 NEXT P1
7300 GO TO 8120
7310 REM     ***********************
7320 F0=F0-2
7330 IF P9<=H0*1.00001 THEN 8360
7340 X=Q(22)
7350 IF F0<=-5 THEN 8190
7360 Q(24)=1.2*(Q7/Q(2))^Q(5)
7370 Q(25)=1.0E+20
7380 IF Q(16)=>N0 THEN 7470
7390 IF F0<=-1 THEN 7470
7400 Q7=0
7410 Q8=10
7420 FOR P1=1 TO N
7430 Q7=Q7+((E0(P1)-P(Q8))/Y0(P1))^2
7440 Q8=Q8+10
7450 NEXT P1
7460 Q(25)=1.4*(Q7/Q(7))^Q(6)
7470 Q(23)=1.0E+20
7480 IF Q(16)<=1 THEN 7550
7490 Q7=0
7500 FOR P1=1 TO N
7510 Q7=Q7+(Y(P3,P1)/Y0(P1))^2
7520 NEXT P1
7530 Q(23)=1.3*(Q7/Q(3))^Q(4)
7540 REM       ********************************
7550 IF Q(24)<=Q(25) THEN 7810
7560 IF Q(25)<Q(23) THEN 7880
7570 Q(20)=10000
7580 IF Q(23)<=1.0E-4 THEN 7600
7590 Q(20)=1/Q(23)
7600 Q(15)=Q(16)-1
7610 Q(10)=10
7620 IF F0<>1 THEN 7640
7630 IF Q(20)<1.1 THEN 8120
7640 IF Q(15)<=Q(16) THEN 7710
7650 REM       ********************************* 
7660 Q8=Q(15)+1
7670 P5=P0(P3)/P3
7680 FOR P1=1 TO N
7690 Y(Q8,P1)=E0(P1)*P5
7700 NEXT P1
7710 P3=Q(15)+1
7720 IF F0=1 THEN 7940
7730 Q(21)=Q(21)*Q(20)
7740 Q(12)=3
7750 GO TO 8430
7760 REM      ***********************
7770 IF Q(15)=Q(16) THEN 5930
7780 Q(16)=Q(15)
7790 GO TO 5040
7800 REM      ***********************
7810 IF Q(24)>Q(23) THEN 7570
7820 Q(15)=Q(16)
7830 Q(20)=10000
7840 IF Q(24)<=1.0E-4 THEN 7610
7850 Q(20)=1/Q(24)
7860 GO TO 7610
7870 REM      ***********************
7880 Q(15)=Q(16)+1
7890 Q(20)=10000
7900 IF Q(25)<=1.0E-4 THEN 7610
7910 Q(20)=1/Q(25)
7920 GO TO 7610
7930 REM      ************************ 
7940 Q(11)=2
7950 IF Q(20)<H1/ABS(P9) THEN 7970
7960 Q(20)=H1/P9
7970 P9=P9*Q(20)
7980 Q(9)=P9
7990 IF Q(15)=Q(16) THEN 8030
8000 Q(16)=Q(15)
8010 GO TO 5040
8020 REM      ************************ 
8030 Q8=1
8040 FOR P2=2 TO P3
8050 Q8=Q8*Q(20)
8060 FOR P1=1 TO N
8070 Y(P2,P1)=Y(P2,P1)*Q8
8080 NEXT P1
8090 NEXT P2
8100 Q(10)=P3
8110 REM      *************************
8120 FOR P1=1 TO N
8130 IF Y0(P1)=>ABS(Y(1,P1)) THEN 8150
8140 Y0(P1)=ABS(Y(1,P1))
8150 NEXT P1
8160 F1=Q(16)
8170 RETURN 
8180 REM      *************************
8190 IF Q(16)=1 THEN 8640
8200 GOSUB 1100
8210 FOR P1=1 TO N
8220 P(P7+P1)=D(P1)
8230 NEXT P1
8240 Q(20)=P9/Q(8)
8250 Q8=2
8260 FOR P1=1 TO N
8270 Y(1,P1)=P(Q8-1)
8280 P(Q8)=Q(8)*P(P7+P1)
8290 Y(2,P1)=P(Q8)*Q(20)
8300 Q8=Q8+10
8310 NEXT P1
8320 Q(16)=1
8330 F0=1
8340 GO TO 5040
8350 REM      ***********************
8360 F0=-1
8370 Q(9)=P9
8380 F1=Q(16)
8390 RETURN 
8400 REM 
8410 REM  SCALE ALL VARIABLES CONNECTED WITH THE STEP SIZE (P9)
8420 REM       AND RETURN TO BEGINNING OF GEAR'S DIFSUB. 
8430 IF Q(21)=>ABS(H0/Q(8)) THEN 8450
8440 Q(21)=ABS(H0/Q(8))
8450 IF Q(21)<=ABS(H1/Q(8)) THEN 8470
8460 Q(21)=ABS(H1/Q(8))
8470 Q8=1
8480 FOR P2=2 TO P3
8490 Q8=Q8*Q(21)
8500 Q7=0
8510 FOR P1=1 TO N
8520 Y(P2,P1)=P((P2+Q7))*Q8
8530 Q7=Q7+10
8540 NEXT P1
8550 NEXT P2
8560 P9=Q(8)*Q(21)
8570 Q7=1
8580 FOR P1=1 TO N
8590 Y(1,P1)=P(Q7)
8600 Q7=Q7+10
8610 NEXT P1
8620 Q(10)=P3
8630 GO TO Q(12) OF 4700,5930,7770
8640 F0=-4
8650 GO TO 6940
8660 REM      ************************** 
8670 REM  END OF GEAR'S DIFSUB (CACM ALG. 407) 
8680 REM      ************************** 
8690 REM 
8700 REM  DECOMP (FORSYTHE&MOLER) -- PERFORMS AN LU
8710 REM          DECOMPOSITION OF Q9(N,N) 
8720 REM  INITIALIZE 
8730 P4=-1
8740 FOR P1=1 TO N
8750 Q6(P1)=P1
8760 Q8=0
8770 FOR P2=1 TO N
8780 Q8=Q8 MAX ABS(Q9(P1,P2))
8790 NEXT P2
8800 IF Q8>1.0E-10 THEN 8820
8810 RETURN 
8820 Q5(P1)=1/Q8
8830 NEXT P1
8840 REM 
8850 REM  GAUSSIAN ELIMINATION WITH PARTIAL PIVOTING 
8860 IF N=1 THEN 9170
8870 FOR P5=1 TO N-1
8880 Q(27)=0
8890 FOR P1=P5 TO N
8900 Q8=Q6(P1)
8910 Q(28)=ABS(Q9(Q8,P5))*Q5(Q8)
8920 IF Q(28)<=Q(27) THEN 8950
8930 Q(27)=Q(28)
8940 Q(30)=P1
8950 NEXT P1
8960 REM    ************************** 
8970 IF ABS(Q(27))>1.0E-10 THEN 8990
8980 RETURN 
8990 IF Q(30)=P5 THEN 9040
9000 P2=Q6(P5)
9010 Q6(P5)=Q6(Q(30))
9020 Q6(Q(30))=P2
9030 REM    ************************** 
9040 Q4=Q6(P5)
9050 Q(29)=Q9(Q4,P5)
9060 FOR P1=P5+1 TO N
9070 Q8=Q6(P1)
9080 Q7=-Q9(Q8,P5)/Q(29)
9090 Q9(Q8,P5)=-Q7
9100 FOR P2=P5+1 TO N
9110 Q9(Q8,P2)=Q9(Q8,P2)+Q7*Q9(Q4,P2)
9120 NEXT P2
9130 NEXT P1
9140 NEXT P5
9150 IF ABS(Q9(Q6(N),N))>1.0E-10 THEN 9170
9160 RETURN 
9170 P4=1
9180 RETURN 
9190 REM   END OF LU DECOMPOSITION ********
9200 REM   ********************************
9210 REM 
9220 REM  SOLVES Q9*X=B FOR X, WHERE Q9 IS IN LU FORM AND "X" AND
9230 REM       "B" ARE BOTH IN THE ARRAY P. (FORSYTHE&MOLER) 
9240 REM  FORWARD SUBSTITUTION 
9250 IF N>1 THEN 9280
9260 P(9)=P(12)/Q9(1,1)
9270 RETURN 
9280 P(9)=P(Q2+Q6(1))
9290 FOR P1=2 TO N
9300 Q8=Q6(P1)
9310 Q7=0
9320 FOR P2=1 TO P1-1
9330 Q7=Q7+Q9(Q8,P2)*P(10*P2-1)
9340 NEXT P2
9350 P(10*P1-1)=P(Q2+Q8)-Q7
9360 NEXT P1
9370 REM 
9380 REM  BACK SUBSTITUTION
9390 P(P7-1)=P((P7-1))/Q9(Q6(N),N)
9400 FOR P5=1 TO N-1
9410 P1=N-P5
9420 Q8=Q6(P1)
9430 Q7=0
9440 FOR P2=P1+1 TO N
9450 Q7=Q7+Q9(Q8,P2)*P(10*P2-1)
9460 NEXT P2
9470 P(10*P1-1)=(P(10*P1-1)-Q7)/Q9(Q8,P1)
9480 NEXT P5
9490 RETURN 
9500 REM    END OF (LU) SOLVE ***************************
9510 REM  *****************************************************


